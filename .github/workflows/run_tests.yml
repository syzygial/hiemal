name: 'tests'

on:
  push:
    branches:
      - 'main'
      - '**-staging'
  pull_request:
  workflow_dispatch:


jobs:
  run_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Prepare Runner
        run: |
          sudo apt-get update
          sudo apt-get install cmake

      - name: Build
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Debug ..
          make
      
      - name: Test
        id: test
        continue-on-error: true
        run: |
          mkdir /tmp/artifacts
          ulimit -c unlimited
          sudo sysctl -w kernel.core_pattern=/tmp/artifacts/core_%e.%p.%s
          cd build && make test

      - name: Get Crash Info
        if: ${{ steps.test.outcome == 'failure' }}
        run: |
          cp build/libhiemal.so build/test/run_tests /tmp/artifacts

      - name: Save Test Results
        if: ${{ steps.test.outcome != 'failure' }}
        run: cp build/test_results.json /tmp/artifacts

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3

        with:
          name: test_results
          path: /tmp/artifacts